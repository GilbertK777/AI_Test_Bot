# 프로그램 핵심 흐름 문서

이 문서는 트레이딩 봇 프로그램의 전체적인 작동 흐름을 설명합니다. 코드를 분석하여 핵심 로직을 단계별로 요약했으며, 향후 테스트 계획 수립 및 유지보수를 위한 기준으로 사용됩니다.

---

## 1. 초기화 (Initialization) - `main.py`

애플리케이션이 시작될 때 수행되는 초기 설정 과정입니다.

1.  **설정 로드 (`config/config.py`)**:
    *   `.env` 파일에서 API 키, 거래할 심볼, 레버리지, 전략 파라미터 등 모든 설정 값을 읽어 `CFG` 클래스에 저장합니다.
    *   필수 환경 변수가 누락되었는지 검사하고, 설정 값의 유효성을 확인합니다.

2.  **거래소 클라이언트 생성**:
    *   설정된 `EXCHANGE_NAME` (`BINANCE` 또는 `BYBIT`)에 따라 해당 거래소와 통신할 수 있는 클라이언트 객체(`BinanceFutures` 또는 `BybitFutures`)를 생성합니다.

3.  **핵심 서비스 주입 (Dependency Injection)**:
    *   프로그램의 주요 기능을 담당하는 서비스 객체들을 생성합니다. 이때, 앞에서 만든 거래소 클라이언트 객체를 필요한 서비스에 전달(주입)합니다.
        *   **`IndicatorRepository`**: 시장 데이터(OHLCV)를 조회하고 기술적 지표를 계산하는 서비스.
        *   **`ModelService`**: 머신러닝 모델을 관리하고 예측을 수행하는 서비스.
        *   **`OrderService`**: 주문 실행, 포지션 관리, 손익 계산을 담당하는 서비스.

4.  **봇 및 대시보드 실행**:
    *   모든 서비스가 주입된 메인 `TradingBot` 객체를 생성합니다.
    *   봇의 핵심 로직인 `loop()` 메서드를 백그라운드 스레드에서 실행시킵니다.
    *   사용자 인터페이스(UI)인 `Streamlit` 대시보드를 메인 스레드에서 실행합니다.

---

## 2. 메인 루프 (Main Loop) - `src/bot/trading_bot.py`

백그라운드에서 무한 반복되며 실제 트레이딩 로직을 수행하는 핵심 부분입니다. `CFG.SLEEP_SEC` 주기로 실행됩니다.

1.  **리스크 관리**: 연속 손실 횟수가 지정된 횟수(`MAX_LOSS`)를 초과하면, 일정 시간(`PAUSE_HR`) 동안 거래를 중단하는지 확인합니다.

2.  **데이터 준비**: `IndicatorRepository`를 통해 최신 시장 데이터와 기술적 지표(EMA, RSI, MACD 등)를 가져옵니다.

3.  **모델 재학습**: 설정된 주기(`RETRAIN_HR`)가 되면, 최신 데이터를 사용하여 `ModelService`의 `train()` 메서드를 호출해 ML 모델을 재학습시킵니다.

4.  **예측 및 전략 적용**:
    *   데이터에 ML 모델의 예측값(상승 확률 `prob_up`)을 추가합니다.
    *   `Strategy.enrich()`를 호출하여 최종 매매 신호(`long`, `short`)를 생성합니다.

5.  **주문 로직 실행**:
    *   **신규 진입**: 현재 포지션이 없고, 새로운 `long` 또는 `short` 신호가 발생하면 `OrderService`를 통해 포지션을 엽니다.
    *   **포지션 관리**: 이미 포지션을 보유 중이라면, 거래소와 상태를 동기화하고 지정된 손절(SL)/익절(TP) 가격에 도달했는지 확인합니다.

---

## 3. 데이터 준비 및 전략 (Data & Strategy) - `src/strategy/strategy.py`

매수/매도 신호를 생성하는 과정입니다.

1.  **규칙 기반 필터링 (Rule-based Filter)**:
    *   기술적 지표(EMA, RSI, MACD)를 조합하여 1차적인 진입 조건을 판단합니다.
    *   `rule_long`: 상승 추세 + 과매도 구간 근접 시 포착.
    *   `rule_short`: 하락 추세 + 과매수 구간 근접 시 포착.

2.  **ML 모델 확인 (ML Confirmation)**:
    *   1차 규칙을 만족한 캔들에서, ML 모델이 예측한 상승 확률(`prob_up`)을 확인합니다.
    *   **롱 진입**: `rule_long`이 참이고, 상승 확률이 `CFG.BUY_TH` 임계값보다 높을 때.
    *   **숏 진입**: `rule_short`가 참이고, 상승 확률이 `CFG.SHORT_TH` 임계값보다 낮을 때.

3.  **청산 신호 생성**:
    *   포지션 보유 중, 모델의 예측 확률이 반대 방향으로 바뀌거나 RSI, MACD 지표가 특정 조건을 만족하면 청산 신호(`exit_l`, `exit_s`)를 생성합니다.

---

## 4. 주문 실행 (Order Execution) - `src/order/order_service.py`

생성된 신호를 바탕으로 실제 주문과 포지션을 관리합니다.

1.  **포지션 진입 (`open_position`)**:
    *   신규 진입 신호가 오면, 설정된 증거금(`MARGIN_PER_TRADE`) 또는 수량(`POS_SIZE`)에 따라 주문 크기를 계산합니다.
    *   `TEST_MODE` 설정에 따라 모의 주문 또는 실제 주문을 실행합니다.

2.  **포지션 관리 (`poll_position_closed`, `sync_position`)**:
    *   **모의 거래**: 매 루프마다 현재 가격을 체크하여 손절/익절 라인에 닿았는지 확인합니다.
    *   **실제 거래**: 거래소 API를 통해 실제 포지션 정보를 조회하고, 로컬 상태와 동기화합니다.

3.  **리스크 관리**:
    *   손실이 발생하면 연속 손실 횟수를 기록합니다.
    *   최대 연속 손실 횟수에 도달하면, 알림을 보내고 일정 시간 동안 신규 진입을 중단합니다.

---

## 5. 주요 서비스 역할 (Core Service Roles)

-   **`IndicatorRepository` (`src/data/`)**: 데이터 공급자. 거래소로부터 OHLCV 데이터를 가져와 캐싱하고, 다양한 기술적 지표를 계산하여 데이터프레임에 추가하는 역할을 담당합니다.
-   **`ModelService` (`src/model/`)**: 예측 전문가. XGBoost 모델을 학습, 저장, 로드하고, 새로운 데이터에 대한 예측 확률을 제공하는 역할을 담당합니다.
-   **`OrderService` (`src/order/`)**: 주문 집행자. 계산된 주문 크기로 거래소에 주문을 내고, 현재 포지션의 상태(진입 가격, 수량, 손익)를 추적하며, 리스크 관리 규칙을 적용하는 역할을 담당합니다.
